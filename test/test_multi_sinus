import Amica
using Amica
using CairoMakie
using MAT
using LinearAlgebra

#using GaussianMixtures
using Distributions: mean
#using SpecialFunctions
#using ComponentArrays
#using Diagonalizations

function mean_squared_error(A,B)
    squared_error = (A .- B) .^ 2
    mse = mean(squared_error)
    return mse
end

#Sinus data from mat file
file = matopen("test/sinus_multimodel_data.mat")
x = read(file, "x")
s = read(file, "s")
#A = read(file, "A")

beta_init = read(file, "beta_init")
mu_init = read(file, "mu_init")
A_init = read(file, "A_init")

close(file)
am = fit(MultiModelAmica,x;maxiter=2000,M=2, m=3, remove_mean = false,do_sphering = false, beta=beta_init, mu=mu_init, A=copy(A_init))
# am2 = fit(MultiModelAmica,x;maxiter=100, m=3, remove_mean = false,do_sphering = false, beta=beta_init, mu=mu_init, A=copy(A_init))
# am3 = fit(MultiModelAmica,x;maxiter=1000, m=3, remove_mean = false,do_sphering = false, beta=beta_init, mu=mu_init, A=copy(A_init))
#@time am = fit(SingleModelAmica,x;maxiter=538, m=3)
#@time am = fit(MultiModelAmica,x;maxiter=50,M=2, m=3)


file = matopen("test/results_sinus_matlab_MultiModel.mat")
matlab_A = read(file,"A")
matlab_A1 = matlab_A[:,:,1]
matlab_A2 = matlab_A[:,:,2]
matlab_LL = read(file, "LL")

close(file)

#---
f = Figure(resolution = (1300, 500))
series(f[1,1],s[:,1:100])
series(f[1,2],s[:,900:1000])

series(f[2,1],x[:,1:100])
series(f[2,2],x[:,900:1000])
f
#--------
f2 = Figure(resolution = (1300, 500))
series(f2[1,1],pinv(am.models[1].A)*x[:,1:100])
series(f2[1,2],pinv(am.models[2].A)*x[:,900:1000])

series(f2[2,1],pinv(matlab_A1)*x[:,1:100])
series(f2[2,2],pinv(matlab_A2)*x[:,900:1000])
f2
#-----------
f3 = Figure(resolution = (1300, 500))
lines(f3[1,1],am.LL)
lines(f3[1,2],vec(matlab_LL))
f3
#-----------
f4 = Figure(resolution = (1300, 250))
series(f4[1,1],pinv(am.models[2].A)*x[:,1:100])
series(f4[1,2],pinv(am.models[1].A)*x[:,900:1000])
f4
#colsize!(f3.layout, 1, Aspect(1, 1.0))
#supertitle = Label(f[6,2], "HIII", fontsize = 20)
#----
#___________________________________________________________
# file = matopen("test/sinus_multimodel_data.mat")
# A_original = read(file, "A")
# close(file)
# series(f[5,1],pinv(A_original)*x[:,1:100])
# series(f[6,1],pinv(am.models[2].A)*x[:,1:100])
# series(f[6,2],pinv(am.models[1].A)*x[:,900:1000])